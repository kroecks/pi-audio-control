<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .container {
            background: #252525;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .active-device {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #3a3a3a;
        }

        .active-device h2 {
            font-size: 14px;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .device-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .volume-label {
            font-size: 14px;
            color: #999;
            min-width: 70px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            background: #3a3a3a;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .volume-value {
            min-width: 45px;
            text-align: right;
            font-weight: 600;
            color: #fff;
        }

        .button {
            background: #3a3a3a;
            color: #fff;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            margin-bottom: 16px;
        }

        .button:hover {
            background: #444;
        }

        .button-primary {
            background: #4a9eff;
        }

        .button-primary:hover {
            background: #3a8eef;
        }

        .section-title {
            font-size: 14px;
            color: #999;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .device-item {
            background: #2a2a2a;
            padding: 14px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .device-item:hover {
            background: #333;
        }

        .device-item.active {
            background: #2a4a6a;
        }

        .device-item.offline {
            opacity: 0.6;
        }

        .device-info {
            flex: 1;
        }

        .device-status {
            font-size: 12px;
            color: #999;
            margin-left: 8px;
        }

        .device-status.active {
            color: #4a9eff;
        }

        .device-status.offline {
            color: #ff6b6b;
        }

        /* Modal/Popout */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #252525;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            color: #fff;
        }

        .modal-body {
            margin-top: 20px;
        }

        .action-button {
            background: #4a9eff;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            width: 100%;
            margin-top: 16px;
        }

        .action-button:hover {
            background: #3a8eef;
        }

        .action-button:disabled {
            background: #3a3a3a;
            cursor: not-allowed;
        }

        .scanning-message {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .spinner {
            border: 3px solid #3a3a3a;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #4a2a2a;
            color: #ff6b6b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .success-message {
            background: #2a4a2a;
            color: #6bff6b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Active Device Section -->
        <div class="active-device">
            <h2>Active Device</h2>
            <div class="device-name" id="activeDeviceName">Loading...</div>
            <div class="volume-control">
                <span class="volume-label">Volume:</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="50">
                <span class="volume-value" id="volumeValue">50%</span>
            </div>
        </div>

        <!-- Pair Bluetooth Button -->
        <button class="button button-primary" onclick="openBluetoothPairing()">
            ðŸ“± Pair New Bluetooth Device
        </button>

        <!-- Audio Devices List -->
        <div class="section-title">Audio Devices</div>
        <div class="device-list" id="deviceList">
            <div style="text-align: center; padding: 20px; color: #999;">Loading devices...</div>
        </div>
    </div>

    <!-- Modal/Popout -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Device Details</h3>
                <button class="close-button" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let currentDevices = [];
        let activeDevice = null;

        // Initialize
        async function init() {
            await refreshDevices();
            await refreshActiveDevice();

            // Set up volume slider
            const volumeSlider = document.getElementById('volumeSlider');
            volumeSlider.addEventListener('input', (e) => {
                document.getElementById('volumeValue').textContent = e.target.value + '%';
            });

            volumeSlider.addEventListener('change', async (e) => {
                await setVolume(parseInt(e.target.value));
            });

            // Refresh every 5 seconds
            setInterval(async () => {
                await refreshDevices();
                await refreshActiveDevice();
            }, 5000);
        }

        async function refreshActiveDevice() {
            try {
                const response = await fetch('/api/active');
                const data = await response.json();
                activeDevice = data;

                document.getElementById('activeDeviceName').textContent = data.description || data.name;
                document.getElementById('volumeSlider').value = data.volume;
                document.getElementById('volumeValue').textContent = data.volume + '%';
            } catch (error) {
                console.error('Error fetching active device:', error);
            }
        }

        async function refreshDevices() {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                currentDevices = data.devices;
                renderDeviceList();
            } catch (error) {
                console.error('Error fetching devices:', error);
            }
        }

        function renderDeviceList() {
            const list = document.getElementById('deviceList');

            if (currentDevices.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No devices found</div>';
                return;
            }

            list.innerHTML = currentDevices.map(device => {
                const statusClass = device.is_active ? 'active' : (device.state === 'offline' ? 'offline' : '');
                const statusText = device.is_active ? '(Active)' : (device.state === 'offline' ? '(Offline)' : '');

                return `
                    <div class="device-item ${statusClass}" onclick='openDeviceDetails(${JSON.stringify(device)})'>
                        <div class="device-info">
                            <div>${device.description || device.name}</div>
                        </div>
                        <span class="device-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');
        }

        async function setVolume(volume) {
            try {
                await fetch('/api/volume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ volume })
                });
            } catch (error) {
                console.error('Error setting volume:', error);
            }
        }

        function openDeviceDetails(device) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = device.description || device.name;

            if (device.state === 'offline' && device.is_bluetooth) {
                modalBody.innerHTML = `
                    <div style="color: #999; margin-bottom: 16px;">This Bluetooth device is currently offline.</div>
                    <button class="action-button" onclick="connectDevice('${device.mac}', '${device.name}')">
                        Connect to Device
                    </button>
                    <div id="connectionStatus"></div>
                `;
            } else {
                modalBody.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <div style="color: #999; margin-bottom: 8px;">Status: ${device.state}</div>
                        <div style="color: #999; margin-bottom: 8px;">Volume: ${device.volume}%</div>
                    </div>
                    ${!device.is_active ? `
                        <button class="action-button" onclick="selectDevice('${device.name}')">
                            Set as Active Device
                        </button>
                    ` : '<div style="color: #4a9eff;">This is the active device</div>'}
                    <div id="deviceActionStatus"></div>
                `;
            }

            modal.classList.add('active');
        }

        async function selectDevice(deviceName) {
            const statusDiv = document.getElementById('deviceActionStatus');
            try {
                await fetch('/api/device/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_name: deviceName })
                });

                statusDiv.innerHTML = '<div class="success-message">Device activated successfully!</div>';
                setTimeout(() => {
                    closeModal();
                    refreshDevices();
                    refreshActiveDevice();
                }, 1000);
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        async function connectDevice(mac, name) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<div class="scanning-message"><div class="spinner"></div>Connecting...</div>';

            try {
                const response = await fetch('/api/bluetooth/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mac, name })
                });

                if (response.ok) {
                    statusDiv.innerHTML = '<div class="success-message">Connected successfully!</div>';
                    setTimeout(() => {
                        closeModal();
                        refreshDevices();
                        refreshActiveDevice();
                    }, 1500);
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<div class="error-message">${error.detail}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">Connection failed: ${error.message}</div>`;
            }
        }

        function openBluetoothPairing() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = 'Pair Bluetooth Device';
            modalBody.innerHTML = `
                <button class="action-button" onclick="startBluetoothScan()">
                    Start Scanning for Devices
                </button>
                <div id="scanResults"></div>
            `;

            modal.classList.add('active');
        }

        async function startBluetoothScan() {
            const resultsDiv = document.getElementById('scanResults');
            resultsDiv.innerHTML = '<div class="scanning-message"><div class="spinner"></div>Scanning for Bluetooth devices...</div>';

            try {
                const response = await fetch('/api/bluetooth/scan');
                const data = await response.json();

                if (data.devices.length === 0) {
                    resultsDiv.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No devices found</div>';
                    return;
                }

                resultsDiv.innerHTML = `
                    <div class="section-title" style="margin-top: 20px;">Found Devices</div>
                    <div class="device-list">
                        ${data.devices.map(device => `
                            <div class="device-item" onclick='pairDevice("${device.mac}", "${device.name}")'>
                                <div class="device-info">
                                    <div>${device.name}</div>
                                    <div style="font-size: 12px; color: #999;">${device.mac}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div id="pairingStatus"></div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-message">Scan failed: ${error.message}</div>`;
            }
        }

        async function pairDevice(mac, name) {
            const statusDiv = document.getElementById('pairingStatus');
            statusDiv.innerHTML = '<div class="scanning-message"><div class="spinner"></div>Pairing with device...</div>';

            try {
                const response = await fetch('/api/bluetooth/pair', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mac, name })
                });

                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = `<div class="success-message">${result.message}</div>`;
                    setTimeout(() => {
                        closeModal();
                        refreshDevices();
                        refreshActiveDevice();
                    }, 2000);
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<div class="error-message">${error.detail}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">Pairing failed: ${error.message}</div>`;
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

        // Initialize on page load
        init();
    </script>
</body>
</html>